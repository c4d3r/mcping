/*! mcping 2014-07-26 */
function isObject(val){return null===val?!1:"function"==typeof val||"object"==typeof val}var ServerComponent=function(id,name){if(this.constructor===ServerComponent)throw new Error("Can't instantiate abstract class");this.id=id,this.name=name,this.players={online:0,max:0,sample:[]},this.version=[],this.favicon=null,this.description=null,this.element=null,this.ping=0,this.drawn=!1,this.available=!1,this.templateDir=""};ServerComponent.prototype.setTemplateDir=function(templateDir){this.templateDir=templateDir},ServerComponent.prototype.calculatePercentage=function(){var players=this.players.online,max=this.players.max;return 0==max?0:players/max*100},ServerComponent.prototype.calculateOnlinePlayers=function(){return this.players.online},ServerComponent.prototype.calculateMaxPlayers=function(){return this.players.max},ServerComponent.prototype.calculatePing=function(){return this.ping},ServerComponent.prototype.update=function(){var self=this;self.draw(function(data){$("#"+self.element.attr("id")).html(data)})},ServerComponent.prototype.draw=function(callback){var self=this,templateFile="server.mst";0==self.available&&(templateFile="server_unavailable.mst"),$.get(self.templateDir+"/"+templateFile,function(template){var data={available:self.available,server:{name:self.name,id:"server-"+self.id,ping:Math.floor(1e3*self.calculatePing())+"ms"},players:{percentage:self.calculatePercentage(),online:self.calculateOnlinePlayers(),max:self.calculateMaxPlayers()},favicon:self.favicon,description:self.description},rendered=Mustache.render(template,data);self.element=$(rendered),self.drawn=!0,"undefined"!=typeof callback&&callback(rendered)})};var HubComposite=function(id,name){ServerComponent.apply(this,[id,name]),this.servers=[]};HubComposite.prototype=Object.create(ServerComponent.prototype),HubComposite.prototype.constructor=HubComposite,HubComposite.prototype.add=function(server){this.servers.push(server)},HubComposite.prototype.remove=function(server){for(var s,i=0;s=this.getServer(i);i++){if(s==server)return this.servers.splice(i,1),!0;if(s.remove(server))return!0}return!1},HubComposite.prototype.getServer=function(id){return this.servers[id]},HubComposite.prototype.calculatePing=function(){var totalPing=0;for(serverKey in this.servers)totalPing+=parseFloat(this.servers[serverKey].ping);return Math.round(totalPing)/this.servers.length},HubComposite.prototype.calculateOnlinePlayers=function(){this.players.online=0;for(var key in this.servers)this.players.online+=this.servers[key].calculateOnlinePlayers();return this.players.online},HubComposite.prototype.calculateMaxPlayers=function(){this.players.max=0;for(var key in this.servers)this.players.max+=this.servers[key].calculateMaxPlayers();return this.players.max};var Server=function(id,name){ServerComponent.apply(this,[id,name])};Server.prototype=Object.create(ServerComponent.prototype),Server.prototype.constructor=Server;var App=function(url,options){(void 0===url||0===url.length)&&$.error("No url specified"),this.configs={url:url,enabledTheme:"default",templateDir:"templates/"},this.configs.templateDir=this.configs.templateDir+this.configs.enabledTheme,this.configs=$.extend({},this.configs,options||{}),this.serverComponents=[],this.data=[],this.isStarted=!1,this.start()};App.prototype.start=function(){var hub,server,self=this,_app=self;$.getJSON(self.configs.url+"/index.php?COMMAND=getserverids",function(serverIds){for(var i in serverIds)if(isObject(serverIds[i])){hub=new HubComposite(i,serverIds[i].name),hub.setTemplateDir(self.configs.templateDir);for(var j=0;j<Object.size(serverIds[i].servers);j++)hub.add(new Server(j,serverIds[i].servers[j].name));_app.serverComponents.push(hub),hub.draw(function(data){$("#servers").append(data)})}else server=new Server(i,serverIds[i]),server.setTemplateDir(self.configs.templateDir),_app.serverComponents.push(server),server.draw(function(data){$("#servers").append(data)});_app.retrieve()})},App.prototype.getServerData=function(serverId){var self=this;$.ajax({type:"POST",url:self.configs.url,data:{id:self.serverComponents[serverId].id},timeout:15e3,dataType:"json",success:function(data){if("undefined"!=typeof data.success&&(self.serverComponents[serverId].available=data.success),isObject(data)&&data.hasOwnProperty("subServers")){var servers=self.serverComponents[serverId].servers;for(var id in servers)$.extend(servers[id],data.subServers[id]);self.serverComponents[serverId].update()}else self.data=data,$.extend(self.serverComponents[serverId],data),self.serverComponents[serverId].update()},error:function(request,status,err){console.log(err),"timeout"==status||console.log(request.responseText)}})},App.prototype.retrieve=function(){var self=this;try{for(id in self.serverComponents)self.getServerData(id)}catch(e){console.log(e.message)}setTimeout(function(){self.retrieve()},1e4)},Object.size=function(obj){var key,size=0;for(key in obj)obj.hasOwnProperty(key)&&size++;return size};